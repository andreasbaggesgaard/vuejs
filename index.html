<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
   


<div class="col-md-12">


<div id="app">
    <router-view class="view"></router-view>
</div>

<!--{{ $data }}-->

<!-- movielist template -->
<template id="movie-list-template">
    <div>
        <div class="container">
            <div class="search">
                <input type="text" v-model="searchTerm" placeholder="Search title.." class="form-control" />

                <div class="search__watchlist">
                  <span class="badge pull-right" v-on:click="viewWatchlist = true">{{listNumber}}</span>
                </div>
                
            </div>
            <br />

            <div class="row">
                <div class="col-md-3" v-for="movie in movieList" v-if="!viewWatchlist">

                <div class="movie" v-on:mouseleave="hideInfo">                   
                        <transition name="fade">
                            <div v-if="showMovieInfo == movie.original_title">
                                <div class="movie__info" v-on:mouseover="showInfo(movie.original_title)">
                                    <h4>{{movie.title}}</h4>
                                    <hr />
                                    <span class="movie__date">{{movie.release_date}}<span>
                                    <img src="~/images/vue/watch.png" width="30px" class="movie__add-icon" v-on:click="saveMovie" v-bind:id="movie.original_title"/>
                                     <hr />
                                        <p class="movie__text" v-if="movie.overview.length < 200">{{movie.overview}}  
                                            <router-link :to="{ name: 'movie', params: { original_title: movie.original_title }}">Read more</router-link> 
                                        </p>
                                        <p class="movie__text" v-else>{{trimText(movie.overview)}}.. 
                                            <router-link :to="{ name: 'movie', params: { original_title: movie.original_title }}">Read more</router-link> 
                                        </p>                                
                                </div>
                            </div> 
                        </transition>  
                    <img v-bind:src="getImage(movie.poster_path)" alt="" width="180" v-on:mouseover="showInfo(movie.original_title)" class="movie__img"/>
                </div>

            </div>

                <!-- If clicked = view movies in watchlist -->
                <div class="col-md-3" v-for="movie in watchList" v-else>
                   
                   
                </div>
                    
            </div>
        </div>

        <!-- watchlist movies -->
        <transition name="fade"> 
            <div v-if="viewWatchlist">
                <div v-for="movie in movieList">
                    <div v-for="(item, index) in watchList">
                        <div v-if="item.id == movie.original_title">
                            <img v-bind:src="getImage(movie.poster_path)" width="80px"/>
                            <button v-on:click="removeMovie(index)" class="btn btn-danger">Remove</button>
                        </div>            
                    </div>
                </div>
                <br />
                 <button v-on:click="viewWatchlist = false" class="btn btn-default">Go back</button>
            </div>         
        </transition>

        </div>
  </template>

<!-- movie detail template -->
  <template id="movie-detail-template">
    <div>
      <router-link to="/">Homepage</router-link>
      {{movie.original_title}}
    </div>
  </template>


<!-- col end -->
</div>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script src="https://unpkg.com/vue@2.0.3/dist/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-router/2.0.1/vue-router.js"></script>
<script src="https://unpkg.com/axios@0.12.0/dist/axios.min.js"></script>
<script src="https://unpkg.com/lodash@4.13.1/lodash.min.js"></script> 
  
<script>

var MovieList = Vue.extend({
    template: '#movie-list-template',
    data: function() {
        return {
        movieList: this.$parent.movieList,
        searchTerm: this.$parent.searchTerm,
        listNumber: this.$parent.listNumber,
        filteredList: this.$parent.filteredList,
        viewWatchlist: this.$parent.viewWatchlist,
        showMovieInfo: this.$parent.showMovieInfo,
        getImage: this.$parent.getImage,
        trimText: this.$parent.trimText,
        watchList: this.$parent.watchList
    }
  },
  methods: {
        showInfo: function(obj){
            this.showMovieInfo = obj                         
        },
         hideInfo: function(obj){
            this.showMovieInfo = ''               
        },
        saveMovie: function(e){
            var clickedElement = e.target;        
            this.watchList.push(new SaveMovie(clickedElement.id));
            localStorage.setItem('watchlist', JSON.stringify(this.watchList));   
            this.listNumber += 1;    
        },
        removeMovie: function(index){
            this.watchList = JSON.parse(localStorage.getItem('watchlist'));
            this.watchList.splice(index, 1);
            localStorage.setItem('watchlist', JSON.stringify(this.watchList));
            this.listNumber -= 1;      
        }
    },
    computed: {
            filteredList(){
            return this.movieList.filter((movie) => {
                return movie.original_title.toLowerCase().includes(this.searchTerm.toLowerCase());
                });
            }
                    
        }
});

var MovieDetail = Vue.extend({
  template: '#movie-detail-template',
  data: function() {
    var movie;
    for (var i = 0; i < this.$parent.movieList.length; i++) {
      if(this.$parent.movieList[i].original_title == this.$route.params.original_title) {
        movie = this.$parent.movieList[i];
        break;
      }
    }    
    return {
      movie: movie
    }
  }
});

var router = new VueRouter({
	mode: 'hash',
	base: window.location.href,
	routes: [
      {path: '/', component: MovieList},
      {name: 'movie', path: '/:original_title', component: MovieDetail }
    ]
});

class SaveMovie{
    constructor(id){
        this.id = id
    }
}

axios.get('https://api.themoviedb.org/3/discover/movie?api_key=917e34c6721123e8d60e6386c9257917&sort_by=popularity.desc')
    .then(function (response) {
    var jsonData = response.data.results
    //console.log(jsonData[0])
    
var app = new Vue({
    router,
    el: "#app",
    data: {
        viewWatchlist: false,
        showMovieInfo: '',
        searchTerm: '',
        listNumber: 0,
        watchList: [],
        movieList: jsonData,
        newMovie: {
            original_title: '',
            release_date: '',
            overview: '',
            image: ''
        }                   
    },         
    methods:{
        getImage: function(image){
            var url = "https://image.tmdb.org/t/p/w300/" + image;
            return url;
        },
        trimText: function(text){
            var string = text;
            var trimmedString = string.substring(0, 200);
            return trimmedString;
        },
        getListNumber: function(){
            var number = this.watchList;
            return this.listNumber = number.length;
        },
        getWatchList: function(){
            this.watchList = JSON.parse(localStorage.getItem('watchlist'));
        }
    },
    beforeMount(){ 
        this.getWatchList();
        this.getListNumber();      
    }
    }).$mount('#app');                         
})
.catch(function (error) {
    console.log(error);
});



  </script>



  </body>
</html>

